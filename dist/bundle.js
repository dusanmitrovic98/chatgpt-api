!function(){"use strict";console.log("Hello, world!");const e={PORT:60001,LOG:!1,poolingFrequency:5e3,checkFrequency:1e3,waitingForResponse:!1,lastPrompt:"",canAskQuestion:!1,sendButtonActive:!1,stopButtonPresent:!1,stopButtonActive:!1,logs:[]};let t="";const o=(t,o=null)=>{if(!e.LOG)return;const n=`${(new Date).toISOString()}: ${t}`;e.logs.push(n);const s=o?`color: ${o}`:"";console.log(`%c${n}`,s)},n=()=>{const t=document.querySelector('[data-testid="send-button"]');t&&(e.sendButtonActive=!t.disabled,o("Send button is "+(e.sendButtonActive?"active":"disabled"))),s(),e.canAskQuestion=!e.sendButtonActive&&!e.stopButtonPresent&&!e.waitingForResponse,o(`Can ask question: ${e.canAskQuestion}`)},s=()=>{const t=document.querySelector('[data-testid="stop-button"]');e.stopButtonPresent=!!t,t?(e.stopButtonActive=!t.disabled,o("Stop button is "+(e.stopButtonActive?"active":"disabled"))):o("Stop button is not present")};function r(e){const t=e.getBoundingClientRect(),o=new MouseEvent("click",{bubbles:!0,cancelable:!0,clientX:Math.floor(t.left+t.width/2),clientY:Math.floor(t.top+t.height/2)});e.dispatchEvent(o)}function c(){const e=document.querySelectorAll('[data-message-author-role="assistant"]');return e.length>0?e[e.length-1].textContent.trim():(console.log("No assistant messages found."),null)}async function i(){const t=`http://localhost:${e.PORT}/latest-prompt`;return new Promise(((o,n)=>{GM_xmlhttpRequest({method:"GET",url:t,onload:async t=>{try{const n=JSON.parse(t.responseText);n.prompt&&n.prompt!==e.lastPrompt?(console.log(`New prompt received: ${n.prompt}`),e.lastPrompt=n.prompt,o(n.prompt)):o(null)}catch(e){console.error("Error parsing server response:",e),n(e)}},onerror:e=>{console.error("Error fetching latest prompt:",e),n(e)}})}))}async function a(o){console.log(`Handling prompt: ${o}`),e.waitingForResponse=!0;const s=await async function(){for(;!e.canAskQuestion;)await new Promise((t=>setTimeout(t,e.checkFrequency))),n();const o=document.querySelector('[contenteditable="true"]'),s=document.querySelector('[data-testid="send-button"]');if(!o||!s)return console.error("Required elements not found"),null;r(o),await new Promise((e=>setTimeout(e,500))),function(e,t){e.textContent=t;const o=new Event("input",{bubbles:!0,cancelable:!0});e.dispatchEvent(o)}(o,e.lastPrompt),await new Promise((e=>setTimeout(e,1e3))),await async function(){for(;!e.sendButtonActive;)await new Promise((t=>setTimeout(t,e.checkFrequency))),n()}(),r(s),e.waitingForResponse=!0;const i=await async function(){let t=c(),o=0;for(;e.stopButtonPresent||o<10;){await new Promise((t=>setTimeout(t,e.checkFrequency))),n();const s=c();s!==t?(t=s,o=0):o++}return t}();return i?(t=i,console.log("%cAssistant's response:","color: green",t)):console.log("%cNo new response received","color: red"),e.waitingForResponse=!1,i}();s?await function(t){return new Promise(((o,n)=>{const s=`http://localhost:${e.PORT}/log-response`;GM_xmlhttpRequest({method:"POST",url:s,data:JSON.stringify({response:t}),headers:{"Content-Type":"application/json"},onload:e=>{console.log("Response logged to server:",e.responseText),window.location.reload(),o()},onerror:e=>{console.error("Error logging response:",e),n(e)}})}))}(s):console.error("Failed to get a response from the assistant"),e.waitingForResponse=!1}new MutationObserver((()=>{n()})).observe(document.body,{childList:!0,subtree:!0}),n(),setInterval(n,e.checkFrequency),window.INTERACTION_STATE=e,async function(){for(;;){if(!e.waitingForResponse){const e=await i();e&&await a(e)}await new Promise((t=>setTimeout(t,e.poolingFrequency)))}}()}();